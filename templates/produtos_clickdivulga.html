<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Produtos - ClickDivulga</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/grupos.css') }}">
</head>
<body>
  <div class="sidebar">
    <h2>ClickDivulga</h2>
    <div class="menu">
      <a href="/painel"><i>🏠</i> Dashboard</a>
      <a href="/criar-link"><i>➕</i> Criar Link</a>
      <a href="/grupos"><i>📊</i> Desempenho de Grupos</a>
      <a href="/produtos" class="active"><i>🛍️</i> Produtos</a>
      <a href="/minha-api"><i>🔐</i> API Shopee</a>
      <a href="/logout"><i>🚪</i> Sair</a>
    </div>
  </div>

  <div class="content">
    <div class="topbar">
      <h1>🛍️ Buscar Produtos com Comissão</h1>
    </div>

    <!-- Filtros -->
    <form method="GET" style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:30px;">
      <select name="filtro_loja" style="padding:10px; border-radius:8px;">
        <option value="">🏪 Todas as lojas</option>
        {% for loja in lojas_disponiveis %}
        <option value="{{ loja }}" {% if request.args.get('filtro_loja') == loja %}selected{% endif %}>{{ loja }}</option>
        {% endfor %}
      </select>
      <select name="filtro_categoria" style="padding:10px; border-radius:8px;">
        <option value="">📂 Todas as categorias</option>
        {% for cat in categorias_disponiveis %}
        <option value="{{ cat }}" {% if request.args.get('filtro_categoria') == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
      <input type="text" name="filtro_termo" placeholder="🔍 Palavra-chave" value="{{ request.args.get('filtro_termo', '') }}" style="flex:1; padding:10px; border-radius:8px;">
      <button type="submit" style="background-color:#5e3ea1; color:white; padding:10px 20px; border:none; border-radius:8px;">Filtrar</button>
    </form>

    {% if resultados %}
    <div style="background:white; padding:30px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
      <h2 style="margin-bottom:20px;">🧠 Minhas Buscas Salvas (Atualizadas)</h2>
      {% set pagina = request.args.get('pagina', default=1) | int %}
      {% set inicio = (pagina - 1) * 20 %}
      {% set fim = inicio + 20 %}
      {% set todos_produtos = [] %}
      {% for item in resultados %}
        {% for p in item.produtos %}
          {% set _ = p.update({'atualizado_em': item.atualizado_em}) %}
          {% set _ = todos_produtos.append(p) %}
        {% endfor %}
      {% endfor %}

      {% if request.args.get('filtro_loja') %}
        {% set loja_filtro = request.args.get('filtro_loja') %}
        {% set todos_produtos = todos_produtos | selectattr('loja', 'equalto', loja_filtro) | list %}
      {% endif %}
      {% if request.args.get('filtro_categoria') %}
        {% set cat_filtro = request.args.get('filtro_categoria') %}
        {% set todos_produtos = todos_produtos | selectattr('categoria', 'equalto', cat_filtro) | list %}
      {% endif %}
      {% if request.args.get('filtro_termo') %}
        {% set termo = request.args.get('filtro_termo').lower() %}
        {% set todos_produtos = todos_produtos | selectattr('titulo', 'lower') | select("search", termo) | list %}
      {% endif %}

      {% set produtos_ordenados = todos_produtos | sort(attribute='atualizado_em', reverse=True) %}
      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        {% for p in produtos_ordenados[inicio:fim] %}
        <div style="background: #f8f8fc; padding: 20px; border-radius: 12px; width: 240px; border: 1px solid #e3dfff;">
          <img src="{{ p.imagem }}" alt="Produto" style="width:100%; height:160px; object-fit:cover; border-radius:8px; margin-bottom: 10px;">
          <strong style="font-size: 0.95rem;">{{ p.titulo }}</strong><br>
          <small style="color:#888;">⏱ Atualizado em: {{ p.atualizado_em[:10] | replace('-', '/') }} às {{ p.atualizado_em[11:16] }}</small><br>
          <small style="color:#666;">💰 R$ {{ p.preco }}</small><br>
          <small style="color:#666;">🏪 {{ p.loja }}</small><br>
          <small style="color:#666;">🌟 Comissão da Loja: {{ p.comissao }}%</small><br>
          <small style="color:#666;">🎥 Live: R$ {{ p.comissao_live }} | 📱 Redes: R$ {{ p.comissao_redes }}</small><br>
        </div>
        {% endfor %}
      </div>

      <div style="margin-top:30px; text-align:center;">
        {% set total_paginas = (produtos_ordenados|length // 20) + (1 if produtos_ordenados|length % 20 > 0 else 0) %}
        {% for p in range(1, total_paginas + 1) %}
          <a href="?pagina={{ p }}&filtro_loja={{ request.args.get('filtro_loja', '') }}&filtro_categoria={{ request.args.get('filtro_categoria', '') }}&filtro_termo={{ request.args.get('filtro_termo', '') }}" style="margin:0 5px; padding:8px 12px; border-radius:6px; background-color:{% if p == pagina %}#5e3ea1{% else %}#eee{% endif %}; color:{% if p == pagina %}white{% else %}black{% endif %}; text-decoration:none;">{{ p }}</a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    function validarCampos() {
      const keyword = document.getElementById("campoKeyword").value.trim();
      const url = document.getElementById("campoUrl").value.trim();
      if (!keyword && !url) {
        alert("Preencha pelo menos a palavra-chave ou o link da Shopee.");
        return false;
      }
      return true;
    }
  </script>
</body>
</html>
