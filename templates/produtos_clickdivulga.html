<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Produtos - ClickDivulga</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/grupos.css') }}">
</head>
<body>
  <div class="sidebar">
    <h2>ClickDivulga</h2>
    <div class="menu">
      <a href="/painel"><i>ğŸ </i> Dashboard</a>
      <a href="/criar-link"><i>â•</i> Criar Link</a>
      <a href="/grupos"><i>ğŸ“Š</i> Desempenho de Grupos</a>
      <a href="/produtos" class="active"><i>ğŸ›ï¸</i> Produtos</a>
      <a href="/minha-api"><i>ğŸ”</i> API Shopee</a>
      <a href="/logout"><i>ğŸšª</i> Sair</a>
    </div>
  </div>

  <div class="content">
    <div class="topbar">
      <h1>ğŸ›ï¸ Buscar Produtos com ComissÃ£o</h1>
    </div>

    <!-- ğŸ” Buscas lado a lado -->
    <div style="display: flex; gap: 30px; flex-wrap: wrap; margin-bottom: 40px;">
      <!-- Palavra-chave ou Link -->
      <div style="flex: 1; background:white; padding:30px; border-radius:16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-width: 300px;">
        <h2 style="margin-bottom:20px; color:#5e3ea1;">ğŸ” Palavra-chave ou Link</h2>
        <form method="POST" action="/buscar-produto" onsubmit="return validarCampos();">
          <label>Categoria:</label>
          <select name="categoria" id="campoCategoria" style="width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px;" required>
            <option value="" disabled selected>-- Selecione uma categoria --</option>
            <option value="100001">Moda Masculina</option>
            <option value="100002">Moda Feminina</option>
            <option value="100003">AcessÃ³rios de Moda</option>
            <option value="100004">Celulares e Gadgets</option>
            <option value="100005">Casa e DecoraÃ§Ã£o</option>
            <option value="100006">EletrÃ´nicos</option>
            <option value="100007">Computadores e AcessÃ³rios</option>
            <option value="100008">EletrodomÃ©sticos</option>
            <option value="100009">Brinquedos</option>
            <option value="100010">Esporte e Lazer</option>
            <option value="100011">Automotivo</option>
            <option value="100012">Livros e Papelaria</option>
            <option value="100013">Beleza e Cuidados</option>
            <option value="100014">Mercado</option>
            <option value="100016">Pet Shop</option>
          </select>

          <label>Palavra-chave:</label>
          <input type="text" name="keyword" id="campoKeyword" placeholder="Ex: whey, ring light"
            style="width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px;">

          <label>Link direto:</label>
          <input type="url" name="url" id="campoUrl" placeholder="https://shopee.com.br/..."
            style="width: 100%; margin: 10px 0 20px; padding: 10px; border-radius: 8px;">

          <button type="submit" style="width: 100%; background-color: #5e3ea1; color: white; padding: 12px; border-radius: 8px;">ğŸ” Buscar Produto</button>
        </form>
      </div>

      <!-- Buscar por Loja -->
      <div style="flex: 1; background:white; padding:30px; border-radius:16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-width: 300px;">
        <h2 style="margin-bottom:20px; color:#5e3ea1;">ğŸª Produtos por Loja</h2>
        <form method="POST" action="/buscar-loja">
          <label>Nome ou link da loja:</label>
          <input type="text" name="loja" placeholder="Ex: niveaoficial ou link da loja"
            style="width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px;" required>

          <label>PreÃ§o mÃ­nimo:</label>
          <input type="number" name="preco_min" step="0.01" placeholder="Ex: 50.00"
            style="width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px;">

          <label>PreÃ§o mÃ¡ximo:</label>
          <input type="number" name="preco_max" step="0.01" placeholder="Ex: 200.00"
            style="width: 100%; margin: 10px 0 20px; padding: 10px; border-radius: 8px;">

          <button type="submit" style="width: 100%; background-color: #5e3ea1; color: white; padding: 12px; border-radius: 8px;">ğŸ” Buscar Loja</button>
        </form>
      </div>
    </div>

    {% if produtos %}
    <div style="background:white; padding:30px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom: 40px;">
      <h2 style="margin-bottom:20px;">ğŸ§¾ Produtos encontrados</h2>
      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        {% for p in produtos %}
        <div style="background: #f8f8fc; padding: 20px; border-radius: 12px; width: 240px; border: 1px solid #e3dfff;">
          <img src="{{ p.imagem }}" alt="Produto" style="width:100%; height:160px; object-fit:cover; border-radius:8px; margin-bottom: 10px;">
          <strong style="font-size: 0.95rem;">{{ p.titulo }}</strong><br>
          <small style="color:#666;">ğŸ’° R$ {{ p.preco }}</small><br>
          <small style="color:#666;">ğŸª {{ p.loja }}</small><br>
          <small style="color:#666;">ğŸŒŸ ComissÃ£o da Loja: {{ p.comissao }}%</small><br>
          <small style="color:#666;">ğŸ¥ Live: R$ {{ p.comissao_live }} | ğŸ“± Redes: R$ {{ p.comissao_redes }}</small><br>
          <small style="color:#888;">â± Atualizado: {{ p.atualizado_em or "agora" }}</small><br>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Buscas Salvas com Filtros e PaginaÃ§Ã£o -->
    {% if resultados %}
    <div style="background:white; padding:30px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
      <form method="GET" style="margin-bottom:20px; display:flex; gap:20px; flex-wrap:wrap;">
        <input type="text" name="filtro_termo" placeholder="ğŸ” Buscar por palavra-chave" style="padding:10px; border-radius:8px; flex:1;">
        <select name="filtro_tipo" style="padding:10px; border-radius:8px;">
          <option value="">ğŸ“‚ Todas as categorias</option>
          <option value="produto">Produtos</option>
          <option value="loja">Lojas</option>
        </select>
        <button type="submit" style="background-color:#5e3ea1; color:white; padding:10px 20px; border:none; border-radius:8px;">Filtrar</button>
      </form>
      <h2 style="margin-bottom:20px;">ğŸ§  Minhas Buscas Salvas (Atualizadas)</h2>
      {% set pagina = request.args.get('pagina', 1, type=int) %}
      {% set inicio = (pagina - 1) * 20 %}
      {% set fim = inicio + 20 %}
      {% set resultados_filtrados = resultados %}
      {% if request.args.get('filtro_termo') %}
        {% set termo_filtro = request.args.get('filtro_termo').lower() %}
        {% set resultados_filtrados = resultados_filtrados | selectattr('termo', 'search', termo_filtro) | list %}
      {% endif %}
      {% if request.args.get('filtro_tipo') %}
        {% set tipo_filtro = request.args.get('filtro_tipo') %}
        {% set resultados_filtrados = resultados_filtrados | selectattr('tipo', 'equalto', tipo_filtro) | list %}
      {% endif %}
      {% set resultados_ordenados = resultados_filtrados|sort(attribute='atualizado_em', reverse=True) %}
      {% set resultados_paginados = resultados_ordenados[inicio:fim] %}
      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        {% for item in resultados_paginados %}
          {% for p in item.produtos[:20] %}
          <div style="background: #f8f8fc; padding: 20px; border-radius: 12px; width: 240px; border: 1px solid #e3dfff;">
            <img src="{{ p.imagem }}" alt="Produto" style="width:100%; height:160px; object-fit:cover; border-radius:8px; margin-bottom: 10px;">
            <strong style="font-size: 0.95rem;">{{ p.titulo }}</strong><br>
            <small style="color:#888;">â± Atualizado em: {{ item.atualizado_em[:10] | replace('-', '/') }} Ã s {{ item.atualizado_em[11:16] }}</small><br>
            <small style="color:#666;">ğŸ’° R$ {{ p.preco }}</small><br>
            <small style="color:#666;">ğŸª {{ p.loja }}</small><br>
            <small style="color:#666;">ğŸŒŸ ComissÃ£o da Loja: {{ p.comissao }}%</small><br>
            <small style="color:#666;">ğŸ¥ Live: R$ {{ p.comissao_live }} | ğŸ“± Redes: R$ {{ p.comissao_redes }}</small><br>
          </div>
          {% endfor %}
        {% endfor %}
      </div>
      <!-- PaginaÃ§Ã£o -->
      <div style="margin-top:30px; text-align:center;">
        {% set total_paginas = (resultados_filtrados|length // 20) + (1 if resultados_filtrados|length % 20 > 0 else 0) %}
        {% for p in range(1, total_paginas + 1) %}
          <a href="?pagina={{ p }}{% if request.args.get('filtro_termo') %}&filtro_termo={{ request.args.get('filtro_termo') }}{% endif %}{% if request.args.get('filtro_tipo') %}&filtro_tipo={{ request.args.get('filtro_tipo') }}{% endif %}"
             style="margin:0 5px; padding:8px 12px; border-radius:6px; background-color:{% if p == pagina %}#5e3ea1{% else %}#eee{% endif %}; color:{% if p == pagina %}white{% else %}black{% endif %}; text-decoration:none;">
            {{ p }}
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    function validarCampos() {
      const keyword = document.getElementById("campoKeyword").value.trim();
      const url = document.getElementById("campoUrl").value.trim();
      const categoria = document.getElementById("campoCategoria").value;
      if (!keyword && !url) {
        alert("Preencha pelo menos a palavra-chave ou o link da Shopee.");
        return false;
      }
      if (!categoria) {
        alert("Selecione uma categoria para buscar.");
        return false;
      }
      return true;
    }
  </script>
</body>
</html>
